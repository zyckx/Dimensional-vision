<template>
  <!-- è¡Œ -->
  <div class="flex-row">
    <!-- åˆ— -->
    <!-- ä¸€å…±æœ‰4åˆ—ï¼Œæ¯ä¸€åˆ—é‡Œçš„å…ƒç´ å•ç‹¬å¡«å…… -->
    <div
      class="flex-column"
      v-for="(item, index) in allColumnData"
      :key="index"
    >
      <div class="flex-column-ele" v-for="curItem in item" :key="curItem.id">
        <img :src="curItem.imgUrl" />
        <p>{{ curItem.desc }}</p>
      </div>
    </div>
  </div>
</template>

<script lang="ts" setup>
import { nextTick, reactive, ref, onMounted } from "vue";
import NodeListOf from "typescript";
type waterFallItem = {
  id: number;
  imgUrl: string;
  desc: string;
};
const columnCount = 4;
let data = ref([
  {
    id: 0,
    imgUrl:
      "https://qcloud.dpfile.com/pc/q7QsMdJq_DS7J4xCUgesjjeicLbUbAFCPHHb8mBoN9o4jyZZRObLs5ym-WtN-3N1G45IiB1YIyNuDTtqzVRwesm_qA1Pf8rFcayTY-n-rG8.jpg",
    desc: "1æŠ˜èµ·ğŸ”¥æˆéƒ½æœ€å¤§è¶…çº§æŠ˜æ‰£åº—â€¼ï¸æ¡ç›¸å› å•¦",
  },
  {
    id: 10,
    imgUrl:
      "https://qcloud.dpfile.com/pc/dHilnjl51w_qQEnsJ83shVOtIGNsQSgLBA8AUgWZrXeipuAflbCJKK6UI9lwcqKpwHHsQ-9MP97gy410T7ZcBMm_qA1Pf8rFcayTY-n-rG8.jpg",
    desc: "æˆéƒ½å¸‚åŒºï½œåœ°é“ç›´è¾¾å…è´¹æ‹ç»£çƒèŠ±æµ· ğŸŒ¸å¥½éœ‡æ’¼",
  },
  {
    id: 10,
    imgUrl:
      "https://qcloud.dpfile.com/pc/dHilnjl51w_qQEnsJ83shVOtIGNsQSgLBA8AUgWZrXeipuAflbCJKK6UI9lwcqKpwHHsQ-9MP97gy410T7ZcBMm_qA1Pf8rFcayTY-n-rG8.jpg",
    desc: "æˆéƒ½å¸‚åŒºï½œåœ°é“ç›´è¾¾å…è´¹æ‹ç»£çƒèŠ±æµ· ğŸŒ¸å¥½éœ‡æ’¼",
  },
  {
    id: 10,
    imgUrl:
      "https://qcloud.dpfile.com/pc/dHilnjl51w_qQEnsJ83shVOtIGNsQSgLBA8AUgWZrXeipuAflbCJKK6UI9lwcqKpwHHsQ-9MP97gy410T7ZcBMm_qA1Pf8rFcayTY-n-rG8.jpg",
    desc: "æˆéƒ½å¸‚åŒºï½œåœ°é“ç›´è¾¾å…è´¹æ‹ç»£çƒèŠ±æµ· ğŸŒ¸å¥½éœ‡æ’¼",
  },
  {
    id: 10,
    imgUrl:
      "https://qcloud.dpfile.com/pc/dHilnjl51w_qQEnsJ83shVOtIGNsQSgLBA8AUgWZrXeipuAflbCJKK6UI9lwcqKpwHHsQ-9MP97gy410T7ZcBMm_qA1Pf8rFcayTY-n-rG8.jpg",
    desc: "æˆéƒ½å¸‚åŒºï½œåœ°é“ç›´è¾¾å…è´¹æ‹ç»£çƒèŠ±æµ· ğŸŒ¸å¥½éœ‡æ’¼",
  },
  {
    id: 10,
    imgUrl:
      "https://qcloud.dpfile.com/pc/dHilnjl51w_qQEnsJ83shVOtIGNsQSgLBA8AUgWZrXeipuAflbCJKK6UI9lwcqKpwHHsQ-9MP97gy410T7ZcBMm_qA1Pf8rFcayTY-n-rG8.jpg",
    desc: "æˆéƒ½å¸‚åŒºï½œåœ°é“ç›´è¾¾å…è´¹æ‹ç»£çƒèŠ±æµ· ğŸŒ¸å¥½éœ‡æ’¼",
  },
  {
    id: 10,
    imgUrl:
      "https://qcloud.dpfile.com/pc/dHilnjl51w_qQEnsJ83shVOtIGNsQSgLBA8AUgWZrXeipuAflbCJKK6UI9lwcqKpwHHsQ-9MP97gy410T7ZcBMm_qA1Pf8rFcayTY-n-rG8.jpg",
    desc: "æˆéƒ½å¸‚åŒºï½œåœ°é“ç›´è¾¾å…è´¹æ‹ç»£çƒèŠ±æµ· ğŸŒ¸å¥½éœ‡æ’¼",
  },
  {
    id: 10,
    imgUrl:
      "https://qcloud.dpfile.com/pc/dHilnjl51w_qQEnsJ83shVOtIGNsQSgLBA8AUgWZrXeipuAflbCJKK6UI9lwcqKpwHHsQ-9MP97gy410T7ZcBMm_qA1Pf8rFcayTY-n-rG8.jpg",
    desc: "æˆéƒ½å¸‚åŒºï½œåœ°é“ç›´è¾¾å…è´¹æ‹ç»£çƒèŠ±æµ· ğŸŒ¸å¥½éœ‡æ’¼",
  },
]);
let allColumnData = reactive<waterFallItem[][]>(
  //   Array.from(new Array(4), () => new Array())
  Array.from(new Array(4), () => [])
);
for (let i = 0; i < data.value.length && i < columnCount; i++) {
  allColumnData[i].push(data.value[i]);
}
// ç€‘å¸ƒæµå¸ƒå±€ï¼šå–å‡ºæ•°æ®æºä¸­æœ€é å‰çš„ä¸€ä¸ªå¹¶æ·»åŠ åˆ°ç€‘å¸ƒæµé«˜åº¦æœ€å°çš„é‚£ä¸€åˆ—ï¼Œç­‰å›¾ç‰‡å®Œå…¨åŠ è½½åé‡å¤è¯¥å¾ªç¯
let observerObj = new IntersectionObserver(
  (entries) => {
    for (const entry of entries) {
      const { target, isIntersecting } = entry;
      if (isIntersecting) {
        addPicture();
        observerObj.unobserve(target);
      }
    }
  },
  {
    rootMargin: "0px 0px 300px 0px", // æå‰åŠ è½½é«˜åº¦
  }
);

let dataIndex = columnCount;
const addPicture = () => {
  if (dataIndex >= data.value.length) {
    alert("å›¾ç‰‡å·²åŠ è½½å®Œæˆ");
    return;
  }

  let columnArray: NodeListOf<HTMLElement> =
    document.querySelectorAll(".flex-column");
  let eleHeight = [];
  for (let i = 0; i < columnArray.length; i++) {
    eleHeight.push(columnArray[i].offsetHeight);
  }

  // æ¯æ¬¡æ‰¾å‡ºæœ€å°çš„
  let minEle = Math.min(...eleHeight);
  let index = eleHeight.indexOf(minEle);

  // ç„¶åæŠŠä¸‹ä¸€ä¸ªdataå…ƒç´ æ·»åŠ åœ¨ä¸Šé¢é«˜åº¦æœ€çŸ®çš„è¿™ä¸€åˆ—é‡Œ
  allColumnData[index].push(data.value[dataIndex++]);

  // ä¸ºäº†é˜²æ­¢æ¸²æŸ“é”™ä¹±ï¼Œæˆ‘ä»¬éœ€è¦ç­‰å¾…å½“å‰è¢«æ·»åŠ åˆ°æœ€ä½åˆ—çš„å…ƒç´ å‡ºç°åœ¨å¯è§†çª—å£åï¼Œå†å»åŠ è½½ä¸‹ä¸€ä¸ªå…ƒç´ 
  nextTick(() => {
    columnArray = document
      .querySelectorAll(".flex-column")
      [index].querySelectorAll(".flex-column-ele");
    observerObj.observe(columnArray[columnArray.length - 1]);
  });
};

onMounted(() => {
  addPicture();
});
</script>

<style lang="less" scoped>
.flex-row {
  display: flex;
  flex-direction: row;
  width: 90vw;
  margin-left: 5vw;
  justify-content: space-around;
  align-items: flex-start;
}

// å¯ä»¥åˆ©ç”¨metaå±æ€§åšä¸€ä¸ªå“åº”å¼ï¼Œæ¯”å¦‚å±å¹•å®½åº¦è¶…è¿‡å¤šå®½å°±æ˜¾ç¤º5åˆ—ï¼Œå±å¹•å®½åº¦ä¸ºå¤šå®½å°±æ˜¾ç¤º4åˆ—
.flex-column {
  display: flex;
  flex-direction: column;
  width: 25%;
  margin: 10px;
}

.flex-column-ele {
  img {
    width: 100%;
    max-height: 500px;
    object-fit: contain;
  }

  padding: 5px;
  margin: 5px;
  background-color: #f8f5f5;
  border-radius: 5px;
  box-shadow: 2px 5px 5px 0px #f3f3f3;
}
</style>
